<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Workers | MAD9022-W21</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Cross Platform Application Development II">
    
    <link rel="preload" href="/W2021/assets/css/0.styles.9c5fa8ba.css" as="style"><link rel="preload" href="/W2021/assets/js/app.5f620c32.js" as="script"><link rel="preload" href="/W2021/assets/js/2.58046445.js" as="script"><link rel="preload" href="/W2021/assets/js/13.6eef42af.js" as="script"><link rel="preload" href="/W2021/assets/js/9.536c9148.js" as="script"><link rel="prefetch" href="/W2021/assets/js/10.3b8e81aa.js"><link rel="prefetch" href="/W2021/assets/js/11.da83352d.js"><link rel="prefetch" href="/W2021/assets/js/12.b7e62dfc.js"><link rel="prefetch" href="/W2021/assets/js/14.d9a3848c.js"><link rel="prefetch" href="/W2021/assets/js/15.9dbe3d80.js"><link rel="prefetch" href="/W2021/assets/js/16.34877f8a.js"><link rel="prefetch" href="/W2021/assets/js/17.42df5c8b.js"><link rel="prefetch" href="/W2021/assets/js/18.d6c2d19c.js"><link rel="prefetch" href="/W2021/assets/js/19.8f274ad4.js"><link rel="prefetch" href="/W2021/assets/js/20.ee15ddf1.js"><link rel="prefetch" href="/W2021/assets/js/21.040787d3.js"><link rel="prefetch" href="/W2021/assets/js/22.c1c08c07.js"><link rel="prefetch" href="/W2021/assets/js/23.24360df1.js"><link rel="prefetch" href="/W2021/assets/js/24.15b158c0.js"><link rel="prefetch" href="/W2021/assets/js/25.f6afa99c.js"><link rel="prefetch" href="/W2021/assets/js/26.e108e2ea.js"><link rel="prefetch" href="/W2021/assets/js/27.901ee059.js"><link rel="prefetch" href="/W2021/assets/js/28.aa362c99.js"><link rel="prefetch" href="/W2021/assets/js/29.03adf946.js"><link rel="prefetch" href="/W2021/assets/js/3.54197ee6.js"><link rel="prefetch" href="/W2021/assets/js/30.3b5bf566.js"><link rel="prefetch" href="/W2021/assets/js/31.e8f8cd55.js"><link rel="prefetch" href="/W2021/assets/js/32.3881a5bc.js"><link rel="prefetch" href="/W2021/assets/js/33.aec743e8.js"><link rel="prefetch" href="/W2021/assets/js/34.989038db.js"><link rel="prefetch" href="/W2021/assets/js/35.0103cacb.js"><link rel="prefetch" href="/W2021/assets/js/36.5cb7f62a.js"><link rel="prefetch" href="/W2021/assets/js/37.23dca0df.js"><link rel="prefetch" href="/W2021/assets/js/38.8d291227.js"><link rel="prefetch" href="/W2021/assets/js/39.7e01411f.js"><link rel="prefetch" href="/W2021/assets/js/4.bb14ba1f.js"><link rel="prefetch" href="/W2021/assets/js/40.a50e72d6.js"><link rel="prefetch" href="/W2021/assets/js/41.87e553d4.js"><link rel="prefetch" href="/W2021/assets/js/42.d17778b7.js"><link rel="prefetch" href="/W2021/assets/js/43.9ee0e615.js"><link rel="prefetch" href="/W2021/assets/js/44.a0384434.js"><link rel="prefetch" href="/W2021/assets/js/45.e12cab43.js"><link rel="prefetch" href="/W2021/assets/js/46.ff49787c.js"><link rel="prefetch" href="/W2021/assets/js/47.931a5164.js"><link rel="prefetch" href="/W2021/assets/js/48.93a1f250.js"><link rel="prefetch" href="/W2021/assets/js/49.ed2942b4.js"><link rel="prefetch" href="/W2021/assets/js/5.a7665843.js"><link rel="prefetch" href="/W2021/assets/js/50.36e0d8ca.js"><link rel="prefetch" href="/W2021/assets/js/51.d12854eb.js"><link rel="prefetch" href="/W2021/assets/js/52.698198e0.js"><link rel="prefetch" href="/W2021/assets/js/53.1b1c9b0c.js"><link rel="prefetch" href="/W2021/assets/js/54.1dbf137a.js"><link rel="prefetch" href="/W2021/assets/js/55.69963126.js"><link rel="prefetch" href="/W2021/assets/js/56.a3a2e578.js"><link rel="prefetch" href="/W2021/assets/js/57.cc80d260.js"><link rel="prefetch" href="/W2021/assets/js/58.efd50c39.js"><link rel="prefetch" href="/W2021/assets/js/59.0a02def4.js"><link rel="prefetch" href="/W2021/assets/js/6.a6f59c61.js"><link rel="prefetch" href="/W2021/assets/js/60.75b38a09.js"><link rel="prefetch" href="/W2021/assets/js/61.c225e561.js"><link rel="prefetch" href="/W2021/assets/js/62.d734d751.js"><link rel="prefetch" href="/W2021/assets/js/63.732d87a3.js"><link rel="prefetch" href="/W2021/assets/js/64.95e1f72f.js"><link rel="prefetch" href="/W2021/assets/js/65.4086fe0e.js"><link rel="prefetch" href="/W2021/assets/js/7.30cb0167.js"><link rel="prefetch" href="/W2021/assets/js/8.0d49ee3f.js">
    <link rel="stylesheet" href="/W2021/assets/css/0.styles.9c5fa8ba.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/W2021/" class="home-link router-link-active"><!----> <span class="site-name">MAD9022-W21</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/W2021/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2021/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2021/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/W2021/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2021/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2021/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/W2021/modules/week1/" class="sidebar-link">Week 1 - Cordova, CSP, NPM</a></li><li><a href="/W2021/modules/week2/" class="sidebar-link">Week 2 - Cordova Android, Classes, ENV</a></li><li><a href="/W2021/modules/week3/" class="sidebar-link">Week 3 - Destructuring, Async, Cordova Camera</a></li><li><a href="/W2021/modules/week4/" class="sidebar-link">Week 4 - Cordova File, SplashScreen, Icons</a></li><li><a href="/W2021/modules/week5/" class="sidebar-link">Week 5 - Iterators, Generators, Maps, Sets, iPhone-X</a></li><li><a href="/W2021/modules/week6/" class="sidebar-link">Week 6 - Cordova Media, CORS</a></li><li><a href="/W2021/modules/week7/" class="sidebar-link">Week 7 - Cordova</a></li><li><a href="/W2021/modules/week8/" class="sidebar-link">Week 8 - Web Workers &amp; Copying Objects</a></li><li><a href="/W2021/modules/week9/" aria-current="page" class="sidebar-link">Week 9 - IndexedDB &amp; Service Workers</a></li><li><a href="/W2021/modules/week10/" class="sidebar-link">Week 10 - PWA Core</a></li><li><a href="/W2021/modules/week11/" class="sidebar-link">Week 11 - PWA Continued</a></li><li><a href="/W2021/modules/week12/" class="sidebar-link">Week 12 - Caching and Custom Protocols</a></li><li><a href="/W2021/modules/week13/" class="sidebar-link">Week 13 - CORS in Detail</a></li><li><a href="/W2021/modules/week14/" class="sidebar-link">Week 14 - Final Project</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="service-workers"><a href="#service-workers" class="header-anchor">#</a> Service Workers</h1> <h2 id="video-playlist-on-service-workers"><a href="#video-playlist-on-service-workers" class="header-anchor">#</a> Video Playlist on Service Workers</h2> <p>Service workers are the core technology behind building Progressive Web Apps (<strong>PWA</strong>). This video series outlines all the core things that you can do with a Service Worker and how. Each video has links in the description to a code GIST that has all the code from the video.</p> <p><a href="https://www.youtube.com/watch?v=NJRu3pmmN-4&amp;list=PLyuRouwmQCjl4iJgjH3i61tkqauM-NTGj" target="_blank" rel="noopener noreferrer">Here is the link to the full playlist<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="service-worker-intro"><a href="#service-worker-intro" class="header-anchor">#</a> Service Worker Intro</h2> <p>A service worker, at its most basic, is just a JavaScript file that runs on it's own thread. It runs independently from the scripts that you would add to your website like this:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/js/app.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Service workers can do almost anything that your webpage script can do except access the DOM. However, they can also do some extra things that webpage scripts can't.</p> <p>A service worker can be thought of as a proxy server, which is a program that runs between the browser and the web server.</p> <p><img src="/W2021/assets/img/proxy-image.7c990254.jpg" alt="proxy server analogy image"></p> <p>It will intercept every request for any file from the browser. We get to decide how to handle those requests. It has it's own Cache that we can use to save files. These things combined allow us to create offline-first web apps.</p> <div title="Intro to Service Workers" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/NJRu3pmmN-4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <h3 id="registration"><a href="#registration" class="header-anchor">#</a> Registration</h3> <p>We connect them to our website by <code>registering</code> them. We call a method to register the service worker script.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Once they are properly registered, they can communicate with every tab and window that loads pages from that same origin. An origin is a combination of protocol, domain, and port. Eg: <code>http://www.example.com:80</code>.</p> <p>Unlike a web worker, a service worker is shared by all the currently running windows and tabs for that domain.</p> <h3 id="lifecycle"><a href="#lifecycle" class="header-anchor">#</a> LifeCycle</h3> <p>Service workers have four main events that they listen for.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>install
activate
fetch
message
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The service worker will run a function, which we define, after each of the events. In these functions we can access our private file cache, an indexedDB, send messages to all the connected tabs, or send AJAX calls to various APIs.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Service workers have a lifecycle that they follow too. Since, the manner in which cached files, database access, and fetch calls are handled, can be very sensitive to the specific version of the client side script in the browser we have to be able to manage the installing and activating of these shared service workers.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>installing -&gt; installed -&gt; waiting -&gt; activating -&gt; activated -&gt; idle -&gt; stopped -&gt; terminated
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/W2021/assets/img/lifecycle.1d49eede.png" alt="lifecycle image"></p> <p><a href="https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle" target="_blank" rel="noopener noreferrer">More reading on the lifeCycle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="chrome-dev-tools-for-service-workers"><a href="#chrome-dev-tools-for-service-workers" class="header-anchor">#</a> Chrome Dev Tools for Service Workers</h3> <p>In Chrome, if you open the Dev Tools and go to the <code>Application</code> tab you will be able to find the tools to examine the Service Worker, Indexed DB, and File Caches. LocalStorage, SessionStorage, and Cookies can also be managed here.</p> <p>In Firefox, the Service worker and the Storage features are split between two tabs in the dev tools.</p> <p>In Safari, support is limited but in the Develop menu, at the top of the screen, There is a Service Worker section that lets you select an origin and then view the console and source developer tool tabs specifically for that service worker.</p> <h2 id="cache-api"><a href="#cache-api" class="header-anchor">#</a> Cache API</h2> <div title="The Cache API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/Gu0t2EW2kfU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <p>When building a cache, the main reason you would want one is to be able to run your website when the network fails or the user turns off their wifi. We want our app to be able to run offline after the initial load.</p> <p>If you have a list of files that you want available if the app is offline, then you should create the cache and save those files during the install event.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// build a cache inside the install event listener</span>
ev<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
  caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'staticCache-ver2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>assets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>staticName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has been updated.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">failed to update </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>staticName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>To delete old versions of a cache, we would do this during the activate event.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ev<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
  caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">keys</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      keys
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token string">'staticCache-ver1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">empties</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//empties is an Array of boolean values.</span>
      <span class="token comment">//one item for each cache deleted</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div title="The Cache API Integration" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZoucFUOHGhk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="waituntil-skipwaiting-claim"><a href="#waituntil-skipwaiting-claim" class="header-anchor">#</a> WaitUntil, SkipWaiting, Claim</h2> <p>The <code>install</code>, <code>activate</code>, <code>fetch</code>, and <code>message</code> events are all <code>ExtendableEvents</code>. That means we can use the <code>ev.waitUntil()</code> method to delay the completion of our event listener function until after a Promise has resolved.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ev<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//function that runs and does something that could take some time</span>
    <span class="token comment">//when we are done we call:</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//which will pass our result back to the waitUntil method</span>
    <span class="token comment">// as a resolved Promise object.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div title="WaitUntil, SkipWaiting, Claim" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/nhkpOK3NfW0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <p>The <code>self.skipWaiting()</code> method tells the service worker that it does not need to wait to be activated. It should skip the <code>waiting</code> phase and immediately start activating. This will trigger the <code>activate</code> event listener function.</p> <p>It is important to remember that the web page still will not be communicating with the new service worker. It still thinks that the old service worker is running.</p> <p>This brings us to the <code>clients.claim()</code> method, which, if run inside the <code>activate</code> event listener function, will find all the windows and tabs that are currently running and tell them that the new service worker is activated and should be referenced now.</p> <h2 id="storage-api"><a href="#storage-api" class="header-anchor">#</a> Storage API</h2> <p>If you want to find out how much storage your cache and indexedDB are taking up, we can use the Storage API to determine thoses sizes on Chrome or Firefox.</p> <div title="How to use the Storage API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/2FDpVXSBRyo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <p>If you just want to examine the sizes of images in a cache then we can use the <code>cache.getAll()</code> method to get an array of <code>Response</code> objects. Then we can loop through those objects and get their <code>content-length</code> header values.</p> <h2 id="fetch-api"><a href="#fetch-api" class="header-anchor">#</a> Fetch API</h2> <p>The fetch API works the same way in a service worker as a <code>fetch()</code> call does in a script running on a webpage.</p> <p>The difference in a service worker is that we are also examining files in our private caches and then making decisions about whether to return a file from a cache or to make a new <code>fetch</code> call.</p> <p>After making a <code>fetch</code> call, depending on whether or not it succeeds we have to make more decisions about returning an alternate file, returning an error, or saving a new file in a cache.</p> <div title="How to manage fetch calls and the cache" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZY0WTY-g_js" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <h3 id="request-and-response-objects"><a href="#request-and-response-objects" class="header-anchor">#</a> Request and Response Objects</h3> <p>The <code>fetch</code> event listener gets a <code>FetchEvent</code> object passed to it. Inside the <code>FetchEvent</code> there is a <code>Request</code> object.</p> <p>The <code>Request</code> object can be passed to either a <code>cache.match()</code> call or a <code>fetch()</code> call. The return value from either of these calls is a <code>Response</code> object wrapped in a Promise, which means that the Promise can be passed directly to a <code>then()</code> method.</p> <p>Both the <code>Request</code> and <code>Response</code> objects have similar structures with <code>.url</code> and <code>.headers</code> properties.</p> <h3 id="headers"><a href="#headers" class="header-anchor">#</a> Headers</h3> <p>Headers are sent with Requests and Responses to and from a Cache or a Server. Inside the Headers object is a list of individual <code>header</code> objects. We can access each header by its key using the <code>headers.get</code> method. Eg:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  ev<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    <span class="token keyword">let</span> req <span class="token operator">=</span> ev<span class="token punctuation">.</span>request<span class="token punctuation">;</span> <span class="token comment">//the Request object</span>
    <span class="token keyword">let</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GET, POST, etc</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">//resp is the Response object</span>
        <span class="token keyword">let</span> type <span class="token operator">=</span> resp<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//type could be text/css or application/json</span>
        <span class="token comment">// or image/jpeg etc.</span>
        <span class="token keyword">let</span> statusCode <span class="token operator">=</span> resp<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
        <span class="token comment">//statusCode could be 200, 404, 500, etc</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>We can use those headers to make decisions about how to handle the response from the server.</p> <h2 id="handling-404-errors"><a href="#handling-404-errors" class="header-anchor">#</a> Handling 404 Errors</h2> <p>When the response status code - <code>resp.status</code>, from the server is a 404 it means that we were able to make a fetch call but the file could not be retrieved. Browsers all have a default internal HTML file that they display when they get a 404 error. This file does not come from the server. It is in the browser.</p> <p>We can replace that default browser error page with our own custom HTML file. We just need to have one in our cache that we can send back from the service worker.</p> <p>If the <code>fetch()</code> call that you make fails because of lack of network connection or lack of wifi then your <code>fetch</code> will trigger the error catch. There are two places that you can catch this error in your code. Eg:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>urlReq<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//this function runs if we got ANY response</span>
      <span class="token comment">//from the server</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//this function runs if the fetch had an error</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//this function runs if the fetch had an error</span>
    <span class="token comment">//AND</span>
    <span class="token comment">//you did not have the error handler function inside</span>
    <span class="token comment">//the then( )</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div title="Offline and 404 error handling" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/MXw4Uh7pnLI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="communication-between-browser-and-service-worker"><a href="#communication-between-browser-and-service-worker" class="header-anchor">#</a> Communication between Browser and Service Worker</h2> <p>If you want to send data back and forth between the service worker and all of its controlled tabs and windows, then we need to have two things inside each webpage script and inside the service worker.</p> <p>The first thing is a listener that waits for the message event.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//in the service worker</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ev.data is the object sent from the webpage</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//in the webpage script</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ev.data is the object sent from the service worker</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>The other thing is a function to send our data. The service worker version is a little more complex because it needs to grab all the clients (tabs and windows) and send the message to each one.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//in the service worker</span>
<span class="token keyword">const</span> <span class="token function-variable function">sendMessage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> allClients <span class="token operator">=</span> <span class="token keyword">await</span> clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> includeUncontrolled<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
    allClients<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//in the webpage script</span>
<span class="token keyword">const</span> <span class="token function-variable function">sendMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div title="messaging and clients API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/ISBjiYYqx6s" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="integrating-indexeddb-with-service-workers"><a href="#integrating-indexeddb-with-service-workers" class="header-anchor">#</a> Integrating IndexedDB with Service Workers</h2> <p>In Service Workers we can apply everything we learned about <a href="/W2021/modules/week9/indexeddb.html">Indexed DB</a>.</p> <p>We can use the <code>activate</code> event as our trigger to <strong>open</strong> and <strong>upgrade</strong> our database.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> db <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//global db variable</span>

<span class="token keyword">let</span> req <span class="token operator">=</span> indexedDB<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'myDB'</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//error opening DB</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function-variable function">onupgradeneeded</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> db <span class="token operator">=</span> ev<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
  <span class="token comment">//create one or more stores</span>
  db<span class="token punctuation">.</span><span class="token function">createObjectStore</span><span class="token punctuation">(</span><span class="token string">'myStore'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    keyPath<span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function-variable function">onsuccess</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//successfully opened</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Once you have your database open and the store created you can use either the <code>fetch</code> event or the <code>message</code> event as triggers to talk to the database.</p> <p>The <code>message</code> event lets us <code>get()</code>, <code>getAll()</code>, <code>add()</code>, <code>put()</code> or <code>delete()</code> data whenever a webpage needs it.</p> <p>The <code>fetch</code> event lets our Service Worker make decisions about whether it needs to make a call to an API before inserting or reading data. You could receive a fetch call from the browser for some new API data. The Service Worker can look for a match in the indexed DB and if it doesn't find one THEN make the actual API call for new data. The new data can be then both saved in the database AND returned to the webpage.</p> <div title="Integrate IndexedDB with Service Workers" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/4NkDiGd0mWc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <p><a href="/W2021/modules/week9/" class="router-link-active">Back to week home page</a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/15/2021, 10:07:27 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/W2021/assets/js/app.5f620c32.js" defer></script><script src="/W2021/assets/js/2.58046445.js" defer></script><script src="/W2021/assets/js/13.6eef42af.js" defer></script><script src="/W2021/assets/js/9.536c9148.js" defer></script>
  </body>
</html>
